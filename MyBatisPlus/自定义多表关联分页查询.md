<h1 align="center">自定义多表关联分页查询</h1>

## 准备表和数据

```sql
-- ----------------------------
-- Table structure for ivan_user
-- ----------------------------
DROP TABLE IF EXISTS `ivan_user`;
CREATE TABLE `ivan_user`  (
  `user_id` int(0) NOT NULL AUTO_INCREMENT,
  `user_name` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL,
  `user_sex` char(8) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL,
  `user_age` int(0) NULL DEFAULT NULL,
  PRIMARY KEY (`user_id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 7 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;

-- ----------------------------
-- Records of ivan_user
-- ----------------------------
INSERT INTO `ivan_user` VALUES (1, 'Tom', '男', 18);
INSERT INTO `ivan_user` VALUES (2, 'Bob', '男', 22);
INSERT INTO `ivan_user` VALUES (3, 'Mary', '女', 17);
INSERT INTO `ivan_user` VALUES (4, 'Jim', '男', 18);
INSERT INTO `ivan_user` VALUES (5, 'Dave', '男', 22);
INSERT INTO `ivan_user` VALUES (6, 'Anly', '女', 17);

DROP TABLE IF EXISTS `ivan_job`;
CREATE TABLE `ivan_job`  (
  `job_id` int(0) NOT NULL AUTO_INCREMENT,
  `job_name` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL,
  `user_id` int(0) NULL DEFAULT NULL,
  PRIMARY KEY (`job_id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 7 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;

-- ----------------------------
-- Records of ivan_job
-- ----------------------------
INSERT INTO `ivan_job` VALUES (1, '教师', 1);
INSERT INTO `ivan_job` VALUES (2, '教师', 2);
INSERT INTO `ivan_job` VALUES (3, '教师', 3);
INSERT INTO `ivan_job` VALUES (4, '警察', 1);
INSERT INTO `ivan_job` VALUES (5, '警察', 2);
INSERT INTO `ivan_job` VALUES (6, '公务员', 1);
```

关系如下：

![image-20210826100743831](https://raw.githubusercontent.com/isIvanTsui/img/master/image-20210826100743831.png)

## 准备业务逻辑：

1. Entity

   ```java
   @TableName(value ="ivan_user")
   @Data
   public class User implements Serializable {
       @TableId(type = IdType.AUTO)
       private Integer userId;
       
       private String userName;
       
       private String userSex;
   
       private Integer userAge;
   
       @TableField(exist = false)
       private static final long serialVersionUID = 1L;
   }
   ```

   ```java
   @TableName(value ="ivan_job")
   @Data
   public class Job implements Serializable {
       @TableId(type = IdType.AUTO)
       private Integer jobId;
   
       private String jobName;
       
       private Integer userId;
   
       @TableField(exist = false)
       private static final long serialVersionUID = 1L;
   }
   ```

2. Controller

   ```java
   @RestController
   public class UserController {
       @Autowired
       private UserService userService;
   
       @GetMapping("user")
       public IPage<List<UserVo>> getAllUsers() {
           IPage<List<UserVo>> userPage = userService.getUsersAndJobs();
           return userPage;
       }
   }
   ```

3. Service

   ```java
   public interface UserService extends IService<User> {
       IPage<List<UserVo>> getUsersAndJobs();
   }
   ```

4. ServiceImpl

   ```java
   @Service
   public class UserServiceImpl extends ServiceImpl<UserMapper, User>
   implements UserService {
   
       @Autowired
       private UserMapper userMapper;
       
       @Override
       public IPage<List<UserVo>> getUsersAndJobs() {
           Page<UserVo> page = new Page<>(1,10);
           UserVo userVo = new UserVo();
           userVo.setUserSex("男");
           IPage<List<UserVo>> userPage = userMapper.getUsersAndJobs(page, userVo);
           return userPage;
       }
   }
   ```

5. mapper

   先观察一下MyBatisPlus现有的单表分页查询方法：

   ![image-20210826102210980](https://raw.githubusercontent.com/isIvanTsui/img/master/image-20210826102210980.png)

   然后模仿写出自己的多表分页查询方法

   ```java
   @Repository
   public interface UserMapper extends BaseMapper<User> {
       IPage<List<UserVo>> getUsersAndJobs(Page<UserVo> page, @Param("userVo")UserVo userVo);
   }
   ```

   > 注意：方法中第一个形参必须是Page，才能有分页效果；返回值可以是IPage，也可以是任意合理类型。

6. mapper.xml

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <!DOCTYPE mapper
           PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
           "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   <mapper namespace="com.ivan.user.mapper.UserMapper">
       <resultMap id="UserVoResult" type="com.ivan.user.vo.UserVo">
           <id property="userId" column="user_id"/>
           <result property="userName" column="user_name"/>
           <result property="userAge" column="user_age"/>
           <result property="userSex" column="user_sex"/>
           <collection property="jobList" ofType="com.ivan.user.entity.Job">
               <id property="jobId" column="job_id"/>
               <result property="userId" column="user_id"/>
               <result property="jobName" column="job_name"/>
           </collection>
       </resultMap>
       <select id="getUsersAndJobs" resultMap="UserVoResult">
           SELECT u.*,
                  j.job_id,
                  j.job_name
           FROM `ivan_user` u
                    JOIN `ivan_job` j ON u.user_id = j.user_id
           <if test="userVo != null and userVo.userSex != null">
               AND u.user_sex = #{userVo.userSex}
           </if>
       </select>
   </mapper>
   ```

## 测试

http://localhost:8081/user

控制台打印出来的SQL：

![image-20210826101723853](https://raw.githubusercontent.com/isIvanTsui/img/master/image-20210826101723853.png)

debug后观察，已经查询到了多表分页后的数据：

![image-20210826101912467](https://raw.githubusercontent.com/isIvanTsui/img/master/image-20210826101912467.png)

## 补充

还有一种写法，但多表操作SQL拼接会有问题，所以这里先自定义单表分页查询来演示

1. Controller

   > 继续添加一个映射

   ```java
   	@GetMapping("user1")
       public List getUsers() {
           IPage<User> userPage = userService.selectPage();
           return userPage.getRecords();
       }
   ```

2. Service

   > 添加一个方法

   ```java
   IPage<User> selectPage();
   ```

3. ServiceImpl

   > 继续添加一个方法

   ```java
   	@Override
       public IPage<User> selectPage() {
           Page<User> page = new Page<>(1,10);
           QueryWrapper<User> wrapper = new QueryWrapper<>();
           wrapper.in("user_id", 1,2);
           wrapper.like("user_name", "o");
           wrapper.orderByAsc("user_id");
           Page<User> userPage = userMapper.selectPage1(page, wrapper);
           return userPage;
       }
   ```

4. mapper

   > 继续添加一个方法，这个方法就跟MyBatisPlus默认单表分页查询方法几乎一样了
   >
   > 这次用注解的形式，SQL不复杂就不写xml了

   ```java
   	@Select("select * from ivan_user ${ew.customSqlSegment}")
       Page<User> selectPage1(Page<User> page, @Param(Constants.WRAPPER) QueryWrapper<User> wrapper);
   ```

5. 测试：

   http://localhost:8081/user1

   控制台打印出来的SQL：

   ![image-20210826103507469](https://raw.githubusercontent.com/isIvanTsui/img/master/image-20210826103507469.png)

   debug后观察，已经查询到了单表分页后的数据：

   ![image-20210826103639561](https://raw.githubusercontent.com/isIvanTsui/img/master/image-20210826103639561.png)

> 最后：单表自定义分页查询就这样搞，多表的SQL拼接上去后会有问题，暂时还不知道怎么解决，兄弟们可以自个儿改造一下上面的多表分页查询代码试试。
